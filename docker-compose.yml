networks:
  # Internal network: gateway <-> ollama only, no internet
  internal:
    internal: true
  # Host-access network: allows port publishing to host (no internet)
  host_access:
    driver: bridge
    internal: false
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
  # External network: internet access (used only when NETWORK_MODE=internet)
  external:
    internal: false

services:
  ollama:
    image: ollama/ollama:latest
    networks:
      - internal
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    # GPU support: use docker-compose.gpu.yml overlay

  # Temporary service to pull models (needs internet, shares volume with ollama)
  ollama-pull:
    image: ollama/ollama:latest
    networks:
      - external
    volumes:
      - ollama_data:/root/.ollama
    profiles:
      - setup
    entrypoint: ["sh", "-c", "ollama serve & sleep 2 && ollama pull ${OLLAMA_MODEL:-qwen2.5-coder:32b}"]

  openclaw-gateway:
    image: openclaw:local
    build:
      context: ./openclaw
      dockerfile: Dockerfile
    depends_on:
      - ollama
    networks:
      - internal
      - host_access
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
    volumes:
      - openclaw_state:/home/node/.openclaw
      - ./config/openclaw.json:/home/node/.openclaw/openclaw.json:ro
      - ./workspace:/home/node/workspace
    ports:
      - "${OPENCLAW_BIND_HOST:-127.0.0.1}:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BIND_HOST:-127.0.0.1}:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    init: true
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=256m
      - /home/node/.cache:size=128m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    command:
      [
        "node",
        "dist/index.mjs",
        "gateway",
        "--bind",
        "lan",
        "--port",
        "${OPENCLAW_GATEWAY_PORT:-18789}"
      ]

  openclaw-cli:
    image: openclaw:local
    networks:
      - internal
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
    volumes:
      - openclaw_state:/home/node/.openclaw
      - ./workspace:/home/node/workspace
    stdin_open: true
    tty: true
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    profiles:
      - cli
    entrypoint: ["node", "dist/index.mjs"]

volumes:
  ollama_data:
  openclaw_state:
