networks:
  # Internal network: gateway <-> ollama only, no internet
  internal:
    internal: true
  # External network: internet access (used only when NETWORK_MODE=internet)
  external:
    internal: false

services:
  ollama:
    image: ollama/ollama:latest
    networks:
      - internal
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    # GPU support: use docker-compose.gpu.yml overlay

  # Temporary service to pull models (needs internet)
  ollama-pull:
    image: ollama/ollama:latest
    networks:
      - internal
      - external
    volumes:
      - ollama_data:/root/.ollama
    profiles:
      - setup
    entrypoint: ["ollama", "pull", "${OLLAMA_MODEL:-qwen2.5-coder:32b}"]
    environment:
      OLLAMA_HOST: "ollama:11434"

  openclaw-gateway:
    image: openclaw:local
    build:
      context: ./openclaw
      dockerfile: Dockerfile
    depends_on:
      - ollama
    networks:
      - internal
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
    volumes:
      - ./config:/home/node/.openclaw:ro
      - ./workspace:/home/node/.openclaw/workspace
    ports:
      - "${OPENCLAW_BIND_HOST:-127.0.0.1}:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BIND_HOST:-127.0.0.1}:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    init: true
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=256m
      - /home/node/.cache:size=128m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    command:
      [
        "node",
        "dist/index.mjs",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "${OPENCLAW_GATEWAY_PORT:-18789}"
      ]

  openclaw-cli:
    image: openclaw:local
    networks:
      - internal
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
    volumes:
      - ./config:/home/node/.openclaw
      - ./workspace:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    profiles:
      - cli
    entrypoint: ["node", "dist/index.mjs"]

volumes:
  ollama_data:
